syntax = "proto3";
 
option java_multiple_files=true;
option java_package="explainabilityService";

service Explanations {
    rpc GetExplanation (ExplanationsRequest) returns (ExplanationsResponse);
    rpc ApplyAffectedActions (ApplyAffectedActionsRequest) returns (ApplyAffectedActionsResponse);
    rpc GetFeatureImportance (FeatureImportanceRequest) returns (FeatureImportanceResponse); 
    rpc RunExperimentHighlights (ExperimentRunsRequest) returns (ExperimentRunsResponse);
}

//------------------ Pipeline - Model Explainability --------------------------------------------------

message HyperparameterList {
    string values = 1; // Possible values for the hyperparameter
    string type = 2; // Type of the hyperparameter: "categorical", "numeric", etc.
}

message Hyperparameters {
    map<string, HyperparameterList> hyperparameter = 1; // Map of hyperparameter name to details
    float metric_value = 2;
}

message ShapContributions {
    string feature_name = 1;      
    double feature_value = 2;
    double shap_value = 3;
}

message DataPaths {
    string X_train = 1;
    string X_test = 2;
    string Y_train = 3;
    string Y_test = 4;
    string Y_pred = 5;
}

message ExplanationsRequest {

    string explanation_type = 1;
    string explanation_method = 2;

    repeated string model = 3; //different paths for the selected workflows
    DataPaths data = 4; //path to dataset file, contains whole dataset 
    string target_column = 5; // target variable of dataset
    map<string, Hyperparameters> hyper_configs = 6; // dictionaire with hyperparameters configs and respected metrics
    string feature1 = 7;
    string feature2 = 8;

    // -----Local/Global Counterfactual Explanation Fields -----
    string query = 9;

    // same as Model explainability plus target target label 
    int32 gcf_size = 10;  // Global Counterfactual (GCF) size
    string cf_generator = 11;  // Counterfactual generator method
    string cluster_action_choice_algo = 12;  // Algorithm for choosing clusters' actions

    // Segmenation Explainability
    optional int32 instance_index = 13;
    optional string segmentation_process_step = 14;

    // Experiment Explainability - specific
    map<string, Hyperparameters> experiment_configs = 15; // map with variability point configs and respective metrics
}


 message Features {
    string feature1 = 1;
    string feature2 = 2;
}

message Axis {
    string axis_name = 1;
    repeated string axis_values= 2;
    string axis_type = 3;
}

message TableContents {
    int32 index=1;
    repeated string values = 2;
    repeated string colour = 3;
}

message EffCost {
   double eff = 1;
   double cost = 2;
}

message ExplanationsResponse {
    string explainability_type = 1;
    string explanation_method = 2;
    string explainability_model = 3;
    string plot_name = 4;
    string plot_descr = 5;
    string plot_type = 6;
    Features features = 7;
    repeated string hyperparameter_list = 8;
    repeated string feature_list = 9;
    Axis xAxis = 10;
    Axis yAxis = 11;
    Axis zAxis = 12; 
    map<string, TableContents> table_contents= 13;
    map<string, TableContents> affected_clusters = 14; 
    map<string, EffCost> eff_cost_actions = 15; 
    float TotalEffectiveness = 16;
    float TotalCost = 17;
    map<string, TableContents> actions = 18;
    map<string, TableContents> features_table = 19;
    map<string, TableContents> attributions_table = 20;
    map<string, TableContents> targets_table = 21;
    repeated string features_table_columns = 22;
    repeated string attributions_table_columns = 23;
    repeated string targets_table_columns = 24;
    repeated int32 available_indices = 25;
    string segmentation_process_step = 26;
    repeated ShapContributions shap_contributions = 27;

}

//------------------ Apply Affected Actions --------------------------------------------------


message ApplyAffectedActionsRequest {
}

message ApplyAffectedActionsResponse {
    map<string, TableContents> applied_affected_actions = 1;
}

//------------------ Get Feature Importance --------------------------------------------------


message FeatureImportance {
    string feature_name = 1;      // Name of the feature
    double importance_score = 2; // Importance score of the feature
}

message FeatureImportanceRequest {
    DataPaths data = 1; // Path to dataset file
    string type = 2;
    repeated string model = 3; // path to model file
}

message FeatureImportanceResponse {
    repeated FeatureImportance feature_importances = 1; // List of top 5 important features
}

//------------------ Experiment Highlights / Runs Processing ------------------

message ExperimentRunsRequest {
    string runs_json = 1;
}

message ExperimentRunsResponse {
    bool success = 1;
    string message = 2;
    double elapsed_time = 3;

    message ClusterMetadata {
        int32 n_workflows = 1;
        double percentage_of_total = 2;
        string medoid_workflow_id = 3;
        int32 medoid_index = 4;
    }

    message FeatureStats {
        double cluster_mean = 1;
        double cluster_std = 2;
        double other_clusters_mean = 3;
        double other_clusters_std = 4;
        string value_category = 5;
        double distinctiveness_score = 6;
        double z_score = 7;
    }

    message FeatureSelectionInsights {
        int32 n_features_selected = 1;
        int32 n_metrics_total = 2;
        repeated string selected_features = 3;
        map<string, FeatureStats> feature_statistics = 4;
    }

    message HighShapFeatures {
        repeated string features = 1;
        map<string, FeatureStats> feature_statistics = 2;
    }

    message CorrelatedFeatureRemoval {
        double max_relationship = 1;
        string related_to = 2;
        repeated string all_relationships = 3;
    }

    message CorrelationAnalysis {
        int32 n_removed_features = 1;
        map<string, CorrelatedFeatureRemoval> removed_features = 2;
    }

    message TradeOff {
        string metric_1 = 1;
        string metric_2 = 2;
        string relationship_type = 3;
        double relationship_strength = 4;
        int32 is_tradeoff = 5;
    }

    message TradeOffAnalysis {
        int32 n_total_tradeoffs = 1;
        int32 n_strong_tradeoffs = 2;
        double strong_threshold = 3;
        repeated TradeOff strong_tradeoffs = 4;
    }

    message HyperparameterPattern {
        string dominant_value = 1;
        double dominant_percentage = 2;
        int32 unique_values = 3;
        map<string, int32> value_distribution = 4;
    }

    message DecisionTreeRule {
        string rule = 1;
        double f1_score = 2;
        double precision = 3;
        double recall = 4;
        int32 n_workflows_in_cluster = 5;
        double combined_score = 6;
    }

    message DistinctFeatures {
        int32 n_distinct_features = 1;
        repeated string features = 2;
        map<string, FeatureStats> feature_statistics = 3;
    }

    message ModelEvaluation {
        double test_auc = 1;
        double balanced_accuracy = 2;
        double precision = 3;
        double recall = 4;
        double f1_score = 5;
        double model_quality_score = 6;
        string quality_interpretation = 7;

        message ConfusionMatrix {
            int32 true_negatives = 1;
            int32 false_positives = 2;
            int32 false_negatives = 3;
            int32 true_positives = 4;
        }

        ConfusionMatrix confusion_matrix = 8;
    }

    message ClusterInsights {
        int32 cluster_id = 1;
        ClusterMetadata metadata = 2;
        FeatureSelectionInsights feature_selection = 3;
        ModelEvaluation model_evaluation = 4;
        HighShapFeatures high_shap_features = 5;
        CorrelationAnalysis correlation_analysis = 6;
        TradeOffAnalysis trade_off_analysis = 7;
        map<string, HyperparameterPattern> hyperparameter_patterns = 8;
        repeated DecisionTreeRule decision_tree_rules = 9;
        DistinctFeatures distinct_features = 10;
    }

    map<string, ClusterInsights> cluster_insights = 4;
}
